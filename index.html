<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Securities Register</title>
    <link rel="icon" href="favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- ADDED: Flatpickr for CM42 date fields -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="app.css">
</head>

<body>
    <div class="container">
        <div class="config-controls">
            <button type="button" id="loadConfigButton" onclick="document.getElementById('loadConfigFile').click()">Load
                Config</button>
            <input type="file" id="loadConfigFile" accept=".json" onchange="loadConfig(event)">
            <button type="button" id="showSaveInputButton" onclick="showFilenameInput()">Save Config</button>
            <input type="text" id="configFilename" placeholder="Enter filename (e.g., register.json)"
                style="display: none;">
            <button type="button" id="saveConfigButton" onclick="saveConfig()" style="display: none;">Confirm
                Save</button>
            <button type="button" id="printAllBtn" class="print-btn">Print All</button>
            <button type="button" id="printRegisterBtn" class="print-btn">Print Register</button>
            <button type="button" id="printSummaryBtn" class="print-btn">Print Summary</button>
            <button type="button" id="printBeneficialBtn" class="print-btn" style="background-color: #17a2b8;">Print
                Beneficial Info</button>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('registerTab')">Shareholder Register</button>
            <button class="tab-btn" onclick="switchTab('beneficialTab')">Beneficial Interest Information</button>
        </div>

        <div id="registerTab" class="tab-content active">
            <fieldset class="company-details">
                <legend>Company Details</legend>
                <div class="company-details-grid">
                    <div class="form-group">
                        <label for="companyName">Company Name:</label>
                        <input type="text" id="companyName" name="companyName" oninput="updateShareholdingSummary()">
                    </div>
                    <div class="form-group">
                        <label for="companyClassOfShares">Company Class of Shares:</label>
                        <input type="text" id="companyClassOfShares" name="companyClassOfShares" value="Ordinary"
                            oninput="updateShareholdingSummary()">
                    </div>
                    <div class="form-group company-details-address-group">
                        <label for="companyAddressTextarea">Company Address:</label>
                        <textarea id="companyAddressTextarea" name="companyAddressTextarea"
                            class="companyAddressTextarea" rows="5"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="authorizedShares">Authorized Amount of Shares:</label>
                        <input type="number" id="authorizedShares" name="authorizedShares" min="0"
                            oninput="validateTotalIssuedShares()">
                    </div>
                    <div class="form-group">
                        <label for="totalSharesIssued">Total Shares Issued:</label>
                        <input type="number" id="totalSharesIssued" name="totalSharesIssued" min="0"
                            oninput="validateTotalIssuedShares(); updateShareholdingSummary();">
                    </div>
                    <div class="form-group" style="grid-column: 1 / 2;">
                        <label for="companyRegNo">Company Registration No.:</label>
                        <input type="text" id="companyRegNo" name="companyRegNo" placeholder="e.g. 2023/123456/07">
                    </div>
                </div>
            </fieldset>

            <div class="shareholder-records-container" id="shareholderRegisterContainer">
                <h3>Shareholder Register</h3>
                <div class="record-bulk-actions">
                    <button type="button" class="bulk-action-btn" id="expandAllBtn">Expand All</button>
                    <button type="button" class="bulk-action-btn" id="collapseAllBtn">Collapse All</button>
                </div>
                <div id="shareholderRegister"></div>
                <div class="add-record-btn-container">
                    <button type="button" class="add-record-btn" id="addNaturalPersonButton">Add Natural Person
                        Record</button>
                    <button type="button" class="add-record-btn" id="addJuristicPersonButton">Add Juristic Person
                        Record</button>
                </div>
            </div>
        </div>

        <div id="beneficialTab" class="tab-content">
            <!-- Beneficial Interest content will be dynamically generated here -->
        </div>

        <div class="shareholding-summary print-new-page">
            <h3>Shareholding Summary</h3>
            <table class="summary-table">
                <thead>
                    <tr>
                        <th class="name-col-header">Shareholder's Name / Entity Name</th>
                        <th class="class-of-shares-col">Class of Shares</th>
                        <th class="percentage-col">Percentage (%)</th>
                        <th class="shares-col">Total Shares Held</th>
                    </tr>
                </thead>
                <tbody id="summaryTableBody"></tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" style="text-align: right; font-weight:bold;">TOTAL:</td>
                        <td id="summaryTotalSharesHeld" class="shares-col" style="font-weight:bold;">0</td>
                    </tr>
                    <tr id="summaryDiscrepancyRow" style="display: none;">
                        <td colspan="4" id="summaryDiscrepancyMessage" class="discrepancy-message"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

    </div>

    <!-- Share Certificate Modal -->
    <div id="certificateModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-controls">
                <button id="printCertificateBtn">Print Certificate</button>
                <button id="closeCertificateBtn">× Close</button>
            </div>
            <div id="certificateContainer">
                <!-- Dynamic certificate content will be injected here by JS -->
            </div>
        </div>
    </div>

    <!-- ADDED: CM42 Securities Transfer Form Modal -->
    <div id="cm42Modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-controls">
                <button id="printCm42Btn">Print CM42</button>
                <button id="closeCm42Btn">× Close</button>
            </div>
            <div id="cm42Container">
                <h1>Securities Transfer Form - CM42</h1>
                <h2>In terms of the Companies Act, 71 of 2008 and the Securities Transfer Tax Act, 25 of 2007</h2>

                <div class="form-section">
                    <h3>A. Details of Securities Being Transferred</h3>
                    <div class="form-grid">
                        <div class="full-width"><label for="cm42-issuer-name">Full Name of issuer of security as shown
                                on certificate</label><input type="text" id="cm42-issuer-name"></div>
                        <div><label for="cm42-security-description">Description of Securities</label><input type="text"
                                id="cm42-security-description"></div>
                        <div><label for="cm42-certificate-numbers">Share Certificate Number(s)</label><input type="text"
                                id="cm42-certificate-numbers"></div>
                        <div><label for="cm42-quantity-figures">Quantity in Figures</label><input type="number"
                                id="cm42-quantity-figures"></div>
                        <div><label for="cm42-quantity-words">Quantity in Words</label><input type="text"
                                id="cm42-quantity-words"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>B. Transfer FROM (Details of current holder / Transferor)</h3>
                    <div class="form-grid">
                        <div><label for="cm42-transferor-name">Full Name(s) as per Share Register</label>
                            <select id="cm42-transferor-name"></select>
                        </div>
                        <div><label for="cm42-transferor-id">ID / Company Registration Number</label><input type="text"
                                id="cm42-transferor-id"></div>
                        <div class="full-width">
                            <p style="font-size: 13px; margin: 15px 0 5px 0;">I/We, the undersigned, hereby transfer the
                                above-mentioned securities from the name(s) aforesaid.</p>
                        </div>
                        <div><label>Signature of Transferor(s) or Authorised Agent</label>
                            <div class="signature-box"></div>
                            <div class="signature-label">Signature</div>
                        </div>
                        <div><label for="cm42-signature-date">Date of Signature</label><input type="text"
                                id="cm42-signature-date" class="date-input" placeholder="DD/MM/YYYY"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>C. Transfer TO (Details of new holder / Transferee)</h3>
                    <div class="form-grid">
                        <div><label for="cm42-transferee-name">Full Name(s) of New Holder</label>
                            <select id="cm42-transferee-name"></select>
                        </div>
                        <div><label for="cm42-transferee-id">ID / Company Registration Number</label><input type="text"
                                id="cm42-transferee-id"></div>
                        <div><label for="cm42-transferee-address">Full Postal Address</label><textarea
                                id="cm42-transferee-address" rows="4"></textarea></div>
                        <div>
                            <label for="cm42-transferee-email">Email Address</label><input type="text"
                                id="cm42-transferee-email">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>D. Consideration and Securities Transfer Tax (STT)</h3>
                    <div class="form-grid">
                        <div><label for="cm42-consideration-amount">Consideration (Price Paid)</label><input type="text"
                                id="cm42-consideration-amount" placeholder="e.g R555,000.00"></div>
                        <div><label for="cm42-transaction-date">Date of Transaction</label><input type="text"
                                id="cm42-transaction-date" class="date-input" placeholder="DD/MM/YYYY"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <template id="transactionRowTemplate">
        <div class="transaction-row">
            <div class="form-group date-col">
                <div class="date-input-group"> <input type="text" name="transactionDate"
                        class="transactionDate visible-date-input" placeholder="DD/MM/YYYY"> <button type="button"
                        class="date-picker-trigger" onclick="showDatePicker(this)"></button> <input type="date"
                        class="hidden-date-input" onchange="updateVisibleDate(this)"> </div>
            </div>
            <div class="form-group new-cert-col"> <input type="text" name="transactionNewCertNo"
                    class="transactionNewCertNo" placeholder="New Cert No."> </div>
            <div class="form-group shares-col"> <input type="number" name="transactionShares" class="transactionShares"
                    min="0" value="0" oninput="handleTransactionChange(this)"> </div>
            <div class="form-group nominal-col"> <input type="text" name="transactionNominalAmount"
                    class="transactionNominalAmount" placeholder="R 0.00" oninput="formatCurrency(this)"> </div>
            <div class="form-group consideration-col"> <input type="text" name="transactionConsideration"
                    class="transactionConsideration" placeholder="R 0.00" oninput="formatCurrency(this)"> </div>
            <div class="form-group transaction-details-col"> <input type="text" name="transactionDetails"
                    class="transactionDetails" placeholder="Transaction Details"> </div>
            <div class="action-col">
                <button type="button" class="generate-cert-btn" title="Generate/View Certificate"
                    onclick="generateCertificate(this)">View Cert</button>
                <button type="button" class="generate-cm42-btn" title="Generate CM42 Transfer Form"
                    onclick="generateCM42(this)">CM42</button>
                <button type="button" class="delete-transaction-row-btn" onclick="deleteTransactionRow(this)">Del
                    Row</button>
            </div>
        </div>
    </template>

    <template id="shareholderRecordTemplate">
        <div class="shareholder-record">
            <div class="shareholder-record-header">
                <span>Shareholder Details & Activity</span>
                <div class="record-header-buttons">
                    <button type="button" class="collapse-record-btn" onclick="toggleRecordCollapse(this)">▲
                        Collapse</button>
                    <button type="button" class="delete-record-btn" onclick="deleteRecord(this)">Delete Record</button>
                </div>
            </div>
            <div class="record-body">
                <div class="owner-details-grid">
                    <div class="form-group-cell" data-cell="name"></div>
                    <div class="form-group-cell" data-cell="dateOfEntry"></div>

                    <div class="form-group-cell" data-cell="r2c1"></div>
                    <div class="form-group-cell" data-cell="r2c2"></div>

                    <div class="form-group-cell" data-cell="r3c1"></div>
                    <div class="form-group-cell" data-cell="r3c2"></div>

                    <div class="form-group-cell" data-cell="r4c1"></div>
                    <div class="form-group-cell" data-cell="r4c2"></div>
                </div>
                <div class="shares-activity-wrapper">
                    <div class="shares-activity-section">
                        <h5>SHARES/SECURITIES ACQUIRED</h5>
                        <div class="transaction-headers">
                            <div class="date-col">Date</div>
                            <div class="new-cert-col">New Cert. No.</div>
                            <div class="shares-col">No of Shares</div>
                            <div class="nominal-col">Nominal Amount</div>
                            <div class="transaction-details-col">Transaction Details</div>
                            <div class="action-col-spacer"></div>
                        </div>
                        <div class="acquired-transactions-container"></div>
                        <button type="button" class="add-transaction-btn"
                            onclick="addTransactionRow(this, 'acquired')">Add Acquired</button>
                    </div>
                    <div class="shares-activity-section">
                        <h5>SHARES/SECURITIES TRANSFERRED</h5>
                        <div class="transaction-headers">
                            <div class="date-col">Date</div>
                            <div class="new-cert-col">New Cert. No.</div>
                            <div class="shares-col">No of Shares</div>
                            <div class="consideration-col">Consideration</div>
                            <div class="transaction-details-col">Transaction Details</div>
                            <div class="action-col-spacer"></div>
                        </div>
                        <div class="transferred-transactions-container"></div>
                        <button type="button" class="add-transaction-btn"
                            onclick="addTransactionRow(this, 'transferred')">Add Transferred</button>
                    </div>
                </div>
                <div class="balance-section">
                    <h5>Balance of Shares Held by this Owner/Entity</h5>
                    <div class="input-row">
                        <div class="form-group"> <label>No. of Shares:</label> <input type="number" name="balanceShares"
                                class="balanceShares" min="0" value="0" readonly style="background-color: #e0e0e0;">
                        </div>
                        <div class="form-group"> <label>Certificate No(s) Held:</label> <input type="text"
                                name="balanceCertNos" class="balanceCertNos"> </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        // --- Global DOM Elements ---
        const addNaturalPersonButton = document.getElementById('addNaturalPersonButton');
        const addJuristicPersonButton = document.getElementById('addJuristicPersonButton');
        const shareholderRegisterDiv = document.getElementById('shareholderRegister');
        const shareholderRecordTemplate = document.getElementById('shareholderRecordTemplate');
        const transactionRowTemplate = document.getElementById('transactionRowTemplate');
        const configFilenameInput = document.getElementById('configFilename');
        const saveConfigButton = document.getElementById('saveConfigButton');
        const showSaveInputButton = document.getElementById('showSaveInputButton');
        const summaryTableBody = document.getElementById('summaryTableBody');
        const summaryTotalSharesHeldEl = document.getElementById('summaryTotalSharesHeld');
        const summaryDiscrepancyRowEl = document.getElementById('summaryDiscrepancyRow');
        const summaryDiscrepancyMessageEl = document.getElementById('summaryDiscrepancyMessage');
        const certificateModal = document.getElementById('certificateModal');
        const certificateContainer = document.getElementById('certificateContainer');
        const cm42Modal = document.getElementById('cm42Modal');
        let cm42DataStore = [];

        // --- Print Buttons ---
        document.getElementById('printAllBtn').addEventListener('click', () => prepareAndPrint('printing-all'));
        document.getElementById('printRegisterBtn').addEventListener('click', () => prepareAndPrint('printing-register'));
        document.getElementById('printSummaryBtn').addEventListener('click', () => prepareAndPrint('printing-summary'));
        document.getElementById('printBeneficialBtn').addEventListener('click', () => prepareAndPrint('printing-beneficial'));

        // --- Bulk Action Buttons ---
        document.getElementById('expandAllBtn').addEventListener('click', () =>
        {
            document.querySelectorAll('#shareholderRegister .shareholder-record').forEach(record => setRecordCollapseState(record, false));
        });
        document.getElementById('collapseAllBtn').addEventListener('click', () =>
        {
            document.querySelectorAll('#shareholderRegister .shareholder-record').forEach(record => setRecordCollapseState(record, true));
        });

        // --- Event Listeners for adding records ---
        addNaturalPersonButton.addEventListener('click', () =>
        {
            addShareholderRecord('natural');
            updateShareholdingSummary();
        });
        addJuristicPersonButton.addEventListener('click', () =>
        {
            addShareholderRecord('juristic');
            updateShareholdingSummary();
        });


        // --- Tab Management ---
        function switchTab(tabId)
        {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-btn[onclick="switchTab('${tabId}')"]`).classList.add('active');

            if (tabId === 'beneficialTab')
            {
                const data = getCurrentStateData();
                renderBeneficialInterestTab(data);
            }
        }

        // --- Data Syncing from Beneficial Tab to Register Tab ---
        function syncBeneficialToRegister(sourceInput, shareholderId, fieldName)
        {
            const registerRecord = document.querySelector(`#shareholderRegister .shareholder-record[data-id="${shareholderId}"]`);
            if (!registerRecord) return;

            const targetInput = registerRecord.querySelector(`[name="${fieldName}"]`);
            if (targetInput)
            {
                if (targetInput.classList.contains('visible-date-input'))
                {
                    setFormattedDate(targetInput, sourceInput.value);
                } else
                {
                    targetInput.value = sourceInput.value;
                }
            }
        }


        // --- Date Picker and Formatting ---
        function showDatePicker(buttonElement)
        {
            const hiddenDateInput = buttonElement.nextElementSibling;
            try { hiddenDateInput.showPicker(); } catch (e) { hiddenDateInput.focus(); }
        }

        function updateVisibleDate(hiddenDateInput)
        {
            const visibleDateInput = hiddenDateInput.parentElement.querySelector('.visible-date-input');
            const yyyymmdd = hiddenDateInput.value;
            if (yyyymmdd)
            {
                const parts = yyyymmdd.split('-');
                visibleDateInput.value = `${parts[2]}/${parts[1]}/${parts[0]}`;
            } else
            {
                visibleDateInput.value = '';
            }
            if (hiddenDateInput.hasAttribute('onchange') && hiddenDateInput.getAttribute('onchange').includes('syncBeneficialToRegister'))
            {
                hiddenDateInput.onchange();
            } else if (visibleDateInput.closest('.shareholder-record'))
            {
                updateShareholdingSummary();
            }
        }

        function getFormattedDate(visibleDateInput)
        {
            return visibleDateInput ? visibleDateInput.value : '';
        }

        function setFormattedDate(visibleDateInput, ddMmYyyy)
        {
            if (!visibleDateInput) return;
            if (ddMmYyyy)
            {
                visibleDateInput.value = ddMmYyyy;
                const hiddenDateInput = visibleDateInput.parentElement.querySelector('.hidden-date-input');
                if (hiddenDateInput)
                {
                    const parts = ddMmYyyy.split('/');
                    if (parts.length === 3) hiddenDateInput.value = `${parts[2]}-${parts[1]}-${parts[0]}`;
                }
            } else
            {
                visibleDateInput.value = '';
                const hiddenDateInput = visibleDateInput.parentElement.querySelector('.hidden-date-input');
                if (hiddenDateInput) hiddenDateInput.value = '';
            }
        }

        function formatCurrency(input)
        {
            let value = input.value;
            if (value === '' || value === 'R ')
            {
                input.value = '';
                return;
            }

            let rawValue = value.replace(/R\s?/g, '').replace(/,/g, '');
            let parts = rawValue.split('.');
            let integerPart = parts[0].replace(/[^0-9]/g, '');
            let decimalPart = parts[1];

            let formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            let newValue = 'R ' + (formattedInteger || '0');

            if (typeof decimalPart !== 'undefined')
            {
                newValue += '.' + decimalPart.replace(/[^0-9]/g, '').substring(0, 2);
            } else if (rawValue.includes('.'))
            {
                newValue += '.';
            }

            if (input.value !== newValue)
            {
                input.value = newValue;
            }
        }

        const formatCm42Currency = (event) =>
        {
            const input = event.target;
            let value = input.value;
            if (!value || value.startsWith('R ')) return;

            let numericValue = parseFloat(value.replace(/[^0-9.,]/g, '').replace(',', '.'));
            if (!isNaN(numericValue))
            {
                const formatter = new Intl.NumberFormat('en-ZA', {
                    style: 'currency',
                    currency: 'ZAR',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                input.value = formatter.format(numericValue);
            } else
            {
                input.value = '';
            }
        };


        // --- Shareholder Register Tab Logic ---
        function buildFieldHtml(type, name, inputClass, labelText, value = '', placeholder = '', oninput = null, rows = null)
        {
            let inputHtml = '';
            const oninputAttr = oninput ? `oninput="${oninput}"` : '';
            value = value || '';

            switch (type)
            {
                case 'text':
                case 'email':
                case 'number':
                    inputHtml = `<input type="${type}" name="${name}" class="${inputClass}" value="${value}" placeholder="${placeholder}" ${oninputAttr}>`;
                    break;
                case 'textarea':
                    const rowsAttr = rows ? `rows="${rows}"` : 'rows="3"';
                    inputHtml = `<textarea name="${name}" class="${inputClass}" ${rowsAttr} placeholder="${placeholder}" ${oninputAttr}>${value}</textarea>`;
                    break;
                case 'date':
                    const dateValueYMD = value ? value.split('/').reverse().join('-') : '';
                    inputHtml = `
                        <div class="date-input-group">
                            <input type="text" name="${name}" class="${inputClass} visible-date-input" placeholder="DD/MM/YYYY" value="${value}">
                            <button type="button" class="date-picker-trigger" onclick="showDatePicker(this)"></button>
                            <input type="date" class="hidden-date-input" onchange="updateVisibleDate(this)" value="${dateValueYMD}">
                        </div>`;
                    break;
            }
            return `<div class="form-group"><label>${labelText}</label>${inputHtml}</div>`;
        }

        function buildIdPassportGroupHtml(idNumberVal = '', idCountryVal = '')
        {
            return `
                <div class="form-group">
                    <div class="id-country-group">
                        <div class="form-group"><label>ID/Passport No.:</label><input type="text" name="idNumber" class="idNumber" placeholder="ID/Passport No." value="${idNumberVal}"></div>
                        <div class="form-group"><label>Country of ID/Passport Issue:</label><input type="text" name="idCountry" class="idCountry" placeholder="Country" value="${idCountryVal}"></div>
                    </div>
                </div>`;
        }

        function buildRegistrationGroupHtml(regNumberVal = '', regCountryVal = '')
        {
            return `
                <div class="form-group">
                    <div class="registration-group">
                        <div class="form-group"><label>Registration number of the entity:</label><input type="text" name="registrationNumber" class="registrationNumber" placeholder="Registration No." value="${regNumberVal}"></div>
                        <div class="form-group"><label>Country of Registration Issue:</label><input type="text" name="registrationCountry" class="registrationCountryInput" placeholder="Country" value="${regCountryVal}"></div>
                    </div>
                </div>`;
        }

        function addShareholderRecord(recordType, data = null)
        {
            const templateContent = shareholderRecordTemplate.content.cloneNode(true);
            const newRecordDiv = templateContent.querySelector('.shareholder-record');
            newRecordDiv.dataset.recordType = recordType;
            newRecordDiv.dataset.id = (data && data.id) ? data.id : 'sh_' + Date.now() + Math.random();
            if (data && data.beneficialInfo)
            {
                newRecordDiv.beneficialInfo = data.beneficialInfo;
            }

            const ownerDetails = data ? data.ownerDetails : {};
            const cells = {
                name: newRecordDiv.querySelector('[data-cell="name"]'),
                dateOfEntry: newRecordDiv.querySelector('[data-cell="dateOfEntry"]'),
                r2c1: newRecordDiv.querySelector('[data-cell="r2c1"]'), r2c2: newRecordDiv.querySelector('[data-cell="r2c2"]'),
                r3c1: newRecordDiv.querySelector('[data-cell="r3c1"]'), r3c2: newRecordDiv.querySelector('[data-cell="r3c2"]'),
                r4c1: newRecordDiv.querySelector('[data-cell="r4c1"]'), r4c2: newRecordDiv.querySelector('[data-cell="r4c2"]'),
            };

            Object.values(cells).forEach(cell => cell.innerHTML = '');
            const entryDateLabel = recordType === 'natural' ? 'Date of Entry as Member:' : 'Date of Entry as a Beneficial Owner:';
            cells.dateOfEntry.innerHTML = buildFieldHtml('date', 'dateOfEntry', 'dateOfEntry', entryDateLabel, ownerDetails.dateOfEntry);
            const classSharesLabel = recordType === 'natural' ? 'Class of Shares (for this member):' : 'Class of Shares (for this beneficial owner):';
            const ceasingDateLabel = recordType === 'natural' ? 'Date of Ceasing as Member:' : 'Date of Ceasing as a Beneficial Owner:';

            if (recordType === 'natural')
            {
                const onNameChange = 'updateShareholdingSummary(); updateCollapsedHeader(this);';
                const firstNameHtml = buildFieldHtml('text', 'firstName', 'firstName', 'First Name:', ownerDetails.firstName, '', onNameChange);
                const surnameHtml = buildFieldHtml('text', 'surname', 'surname', 'Surname:', ownerDetails.surname, '', onNameChange);
                cells.name.innerHTML = `<div class="name-group">${firstNameHtml}${surnameHtml}</div>`;
                cells.r2c1.innerHTML = buildFieldHtml('textarea', 'ownerAddress', 'ownerAddress', 'Address:', ownerDetails.address, '', 'updateShareholdingSummary()', 5);
                cells.r2c2.innerHTML = buildFieldHtml('date', 'dateOfBirth', 'dateOfBirth', 'Date of Birth:', ownerDetails.dateOfBirth, 'updateShareholdingSummary()');
                cells.r3c1.innerHTML = buildFieldHtml('email', 'ownerEmail', 'ownerEmail', 'Email Address:', ownerDetails.email, '', 'updateShareholdingSummary()');
                cells.r3c2.innerHTML = buildIdPassportGroupHtml(ownerDetails.idNumber, ownerDetails.idCountry);
                cells.r4c1.innerHTML = buildFieldHtml('text', 'classOfShares', 'classOfShares', classSharesLabel, ownerDetails.classOfShares, '', 'updateShareholdingSummary()');
                cells.r4c2.innerHTML = buildFieldHtml('date', 'dateOfCeasing', 'dateOfCeasing', ceasingDateLabel, ownerDetails.dateOfCeasing);
            } else if (recordType === 'juristic')
            {
                cells.name.innerHTML = buildFieldHtml('text', 'ownerName', 'ownerName', 'Name of entity:', ownerDetails.name, '', 'updateShareholdingSummary(); updateCollapsedHeader(this);');
                cells.r2c1.innerHTML = buildRegistrationGroupHtml(ownerDetails.registrationNumber, ownerDetails.registrationCountry);
                cells.r2c2.innerHTML = buildFieldHtml('email', 'ownerEmail', 'ownerEmail', 'Email Address:', ownerDetails.email, 'updateShareholdingSummary()');
                cells.r3c1.innerHTML = buildFieldHtml('textarea', 'ownerAddress', 'ownerAddress', 'Address:', ownerDetails.address, '', 'updateShareholdingSummary()', 5);
                let r3c2_content = buildFieldHtml('text', 'classOfShares', 'classOfShares', classSharesLabel, ownerDetails.classOfShares, '', 'updateShareholdingSummary()');
                r3c2_content += `<div style="margin-top: 10px;">${buildFieldHtml('date', 'dateOfCeasing', 'dateOfCeasing', ceasingDateLabel, ownerDetails.dateOfCeasing)}</div>`;
                cells.r3c2.innerHTML = r3c2_content;
            }
            newRecordDiv.querySelectorAll('.idNumber, .idCountry, .registrationNumber, .registrationCountryInput').forEach(el => el.addEventListener('input', updateShareholdingSummary));
            shareholderRegisterDiv.appendChild(newRecordDiv);

            if (data)
            {
                if (data.acquiredTransactions) data.acquiredTransactions.forEach(txData => addTransactionRow(newRecordDiv.querySelector('.add-transaction-btn[onclick*="acquired"]'), 'acquired', txData));
                if (data.transferredTransactions) data.transferredTransactions.forEach(txData => addTransactionRow(newRecordDiv.querySelector('.add-transaction-btn[onclick*="transferred"]'), 'transferred', txData));
                newRecordDiv.querySelector('.balanceShares').value = data.balance.shares || 0;
                newRecordDiv.querySelector('.balanceCertNos').value = data.balance.certNos || '';
            } else
            {
                calculateShareholderBalance(newRecordDiv);
            }
            return newRecordDiv;
        }

        function updateCollapsedHeader(inputElement)
        {
            const recordDiv = inputElement.closest('.shareholder-record');
            if (!recordDiv || !recordDiv.classList.contains('collapsed')) return;
            const headerSpan = recordDiv.querySelector('.shareholder-record-header > span');
            let ownerName = (recordDiv.dataset.recordType === 'natural')
                ? `${recordDiv.querySelector('.firstName')?.value || ''} ${recordDiv.querySelector('.surname')?.value || ''}`.trim()
                : recordDiv.querySelector('.ownerName')?.value;
            headerSpan.textContent = `Shareholder Details & Activity - ${ownerName || 'Unnamed Record'}`;
        }

        function toggleRecordCollapse(buttonElement)
        {
            const recordDiv = buttonElement.closest('.shareholder-record');
            if (recordDiv) setRecordCollapseState(recordDiv, !recordDiv.classList.contains('collapsed'));
        }

        function setRecordCollapseState(recordDiv, shouldCollapse)
        {
            const recordBody = recordDiv.querySelector('.record-body');
            const collapseBtn = recordDiv.querySelector('.collapse-record-btn');
            const headerSpan = recordDiv.querySelector('.shareholder-record-header > span');
            if (shouldCollapse)
            {
                recordBody.style.display = 'none';
                collapseBtn.textContent = '▼ Expand';
                recordDiv.classList.add('collapsed');
                updateCollapsedHeader(collapseBtn);
            } else
            {
                recordBody.style.display = 'block';
                collapseBtn.textContent = '▲ Collapse';
                recordDiv.classList.remove('collapsed');
                headerSpan.textContent = 'Shareholder Details & Activity';
            }
        }

        function deleteRecord(buttonElement)
        {
            if (confirm('Are you sure you want to delete this entire shareholder record?'))
            {
                const recordToDelete = buttonElement.closest('.shareholder-record');
                if (recordToDelete)
                {
                    recordToDelete.remove();
                    updateShareholdingSummary();
                }
            }
        }

        function addTransactionRow(buttonElementOrDiv, type, data = null)
        {
            const shareholderRecordDiv = buttonElementOrDiv.closest('.shareholder-record');
            const container = shareholderRecordDiv.querySelector(type === 'acquired' ? '.acquired-transactions-container' : '.transferred-transactions-container');
            const newRowTemplate = transactionRowTemplate.content.cloneNode(true);
            const newRow = newRowTemplate.querySelector('.transaction-row');

            if (type === 'acquired')
            {
                newRow.querySelector('.form-group.consideration-col')?.remove();
                newRow.querySelector('.generate-cm42-btn')?.remove();
            } else if (type === 'transferred')
            {
                newRow.querySelector('.form-group.nominal-col')?.remove();
                newRow.querySelector('.generate-cert-btn')?.remove();
            }

            container.appendChild(newRow);

            if (data)
            {
                setFormattedDate(newRow.querySelector('.transactionDate.visible-date-input'), data.date);
                newRow.querySelector('.transactionNewCertNo').value = data.newCertNo || '';
                newRow.querySelector('.transactionShares').value = data.shares || 0;
                newRow.querySelector('.transactionDetails').value = data.details || '';
                if (newRow.querySelector('.transactionNominalAmount'))
                {
                    newRow.querySelector('.transactionNominalAmount').value = data.nominalAmount || '';
                }
                if (newRow.querySelector('.transactionConsideration'))
                {
                    newRow.querySelector('.transactionConsideration').value = data.consideration || '';
                }
            }
            calculateShareholderBalance(shareholderRecordDiv);
            return newRow;
        }

        function deleteTransactionRow(buttonElement)
        {
            const rowToDelete = buttonElement.closest('.transaction-row');
            const shareholderRecordDiv = buttonElement.closest('.shareholder-record');
            if (rowToDelete)
            {
                rowToDelete.remove();
                if (shareholderRecordDiv) calculateShareholderBalance(shareholderRecordDiv);
            }
        }

        function handleTransactionChange(inputElement)
        {
            calculateShareholderBalance(inputElement.closest('.shareholder-record'));
        }

        function calculateShareholderBalance(shareholderRecordDiv)
        {
            if (!shareholderRecordDiv) return;
            let totalAcquired = 0, totalTransferred = 0;
            shareholderRecordDiv.querySelectorAll('.acquired-transactions-container .transactionShares').forEach(input => totalAcquired += parseInt(input.value) || 0);
            shareholderRecordDiv.querySelectorAll('.transferred-transactions-container .transactionShares').forEach(input => totalTransferred += parseInt(input.value) || 0);
            const balanceSharesInput = shareholderRecordDiv.querySelector('.balanceShares');
            const newBalance = Math.max(0, totalAcquired - totalTransferred);
            if (balanceSharesInput.value !== String(newBalance))
            {
                balanceSharesInput.value = newBalance;
                updateShareholdingSummary();
            }
        }

        // --- Beneficial Interest Tab Logic ---
        function createBeneficialFormGroup(fieldName, shareholderId, label, type = 'text', value = '', options = {})
        {
            const group = document.createElement('div');
            group.className = 'form-group';
            const uniqueId = `ben_${fieldName}_${shareholderId}`;
            const labelEl = document.createElement('label');
            labelEl.setAttribute('for', uniqueId);
            labelEl.textContent = label;
            group.appendChild(labelEl);

            if (type === 'select')
            {
                const selectEl = document.createElement('select');
                selectEl.id = uniqueId;
                selectEl.name = uniqueId;
                options.choices.forEach(choice =>
                {
                    const optionEl = document.createElement('option');
                    optionEl.value = choice.value;
                    optionEl.textContent = choice.text;
                    if (String(choice.value) === String(value)) optionEl.selected = true;
                    selectEl.appendChild(optionEl);
                });
                group.appendChild(selectEl);
            } else if (type === 'textarea')
            {
                const textareaEl = document.createElement('textarea');
                textareaEl.id = uniqueId;
                textareaEl.name = uniqueId;
                textareaEl.rows = options.rows || 4;
                textareaEl.textContent = value;
                if (options.readonly) textareaEl.readOnly = true;
                group.appendChild(textareaEl);
            } else if (type === 'date')
            {
                const dateValueYMD = value ? value.split('/').reverse().join('-') : '';
                const wrapper = document.createElement('div');
                wrapper.className = 'date-input-group';
                let onchangeHandler = `updateVisibleDate(this);`;
                if (options.isLinked)
                {
                    onchangeHandler += ` syncBeneficialToRegister(this.parentElement.querySelector('.visible-date-input'), '${shareholderId}', '${fieldName}');`;
                }
                wrapper.innerHTML = `
                    <input type="text" id="${uniqueId}" name="${uniqueId}" class="visible-date-input" placeholder="DD/MM/YYYY" value="${value || ''}" oninput="${options.isLinked ? `syncBeneficialToRegister(this, '${shareholderId}', '${fieldName}')` : ''}">
                    <button type="button" class="date-picker-trigger" onclick="showDatePicker(this)"></button>
                    <input type="date" class="hidden-date-input" onchange="${onchangeHandler}" value="${dateValueYMD}">`;
                group.appendChild(wrapper);
            } else
            {
                const inputEl = document.createElement('input');
                inputEl.type = 'text';
                inputEl.id = uniqueId;
                inputEl.name = uniqueId;
                inputEl.value = value;
                if (options.readonly) inputEl.readOnly = true;
                if (options.isLinked)
                {
                    inputEl.setAttribute('oninput', `syncBeneficialToRegister(this, '${shareholderId}', '${fieldName}')`);
                }
                group.appendChild(inputEl);
            }
            return group;
        }

        function toggleBeneficialCollapse(buttonElement)
        {
            const recordDiv = buttonElement.closest('.info-record');
            setBeneficialCollapseState(recordDiv, recordDiv.classList.contains('collapsed'));
        }

        function setBeneficialCollapseState(recordDiv, shouldExpand)
        {
            const body = recordDiv.querySelector('.record-body');
            const btn = recordDiv.querySelector('.collapse-beneficial-btn');
            if (shouldExpand)
            {
                body.style.display = 'grid';
                btn.textContent = '▲ Collapse';
                recordDiv.classList.remove('collapsed');
            } else
            {
                body.style.display = 'none';
                btn.textContent = '▼ Expand';
                recordDiv.classList.add('collapsed');
            }
        }

        function renderBeneficialInterestTab(data)
        {
            const container = document.getElementById('beneficialTab');
            container.innerHTML = '<h3>Beneficial Interest Register</h3>'; // Add heading

            const bulkActions = document.createElement('div');
            bulkActions.className = 'record-bulk-actions';
            bulkActions.innerHTML = `
                <button type="button" class="bulk-action-btn" id="expandAllBeneficialBtn">Expand All</button>
                <button type="button" class="bulk-action-btn" id="collapseAllBeneficialBtn">Collapse All</button>
            `;
            container.appendChild(bulkActions);

            const companyTotalIssuedShares = parseInt(data.companyDetails.totalSharesIssued) || 0;
            const naturalPersons = data.shareholders.filter(sh => sh.ownerDetails.recordType === 'natural');

            if (naturalPersons.length === 0)
            {
                container.innerHTML += '<p id="noDataMessage">No Natural Person records found. Add them on the "Shareholder Register" tab first.</p>';
                return;
            }

            naturalPersons.forEach(shareholder =>
            {
                const ownerInfo = shareholder.ownerDetails;
                const beneficialInfo = shareholder.beneficialInfo || {};
                const id = shareholder.id;
                const recordDiv = document.createElement('div');
                recordDiv.className = 'info-record';
                recordDiv.dataset.id = id;

                const header = document.createElement('div');
                header.className = 'info-record-header';
                header.innerHTML = `
                    <span>Beneficial Owner: ${ownerInfo.firstName || ''} ${ownerInfo.surname || ''}</span>
                    <button class="collapse-beneficial-btn" onclick="toggleBeneficialCollapse(this)">▲ Collapse</button>
                `;
                recordDiv.appendChild(header);

                const recordBody = document.createElement('div');
                recordBody.className = 'record-body info-grid';
                recordDiv.appendChild(recordBody);

                const balanceShares = parseInt(shareholder.balance.shares) || 0;
                let percentage = (companyTotalIssuedShares > 0 && balanceShares > 0) ? ((balanceShares / companyTotalIssuedShares) * 100).toFixed(2) : 0;

                recordBody.appendChild(createBeneficialFormGroup('firstName', id, 'First Name', 'text', ownerInfo.firstName, { readonly: true }));
                recordBody.appendChild(createBeneficialFormGroup('surname', id, 'Surname', 'text', ownerInfo.surname, { readonly: true }));
                recordBody.appendChild(createBeneficialFormGroup('dateOfBirth', id, 'Date of Birth', 'date', ownerInfo.dateOfBirth, { isLinked: true }));
                recordBody.appendChild(createBeneficialFormGroup('idNumber', id, 'ID/Passport Number', 'text', ownerInfo.idNumber, { isLinked: true }));
                recordBody.appendChild(createBeneficialFormGroup('saCitizen', id, 'Are you a South African Citizen?', 'select', beneficialInfo.saCitizen || 'Yes', { choices: [{ value: 'Yes', text: 'Yes' }, { value: 'No', text: 'No' }] }));
                recordBody.appendChild(createBeneficialFormGroup('issueDate', id, 'ID/Passport Issue Date', 'date', beneficialInfo.issueDate));
                recordBody.appendChild(createBeneficialFormGroup('email', id, 'Email', 'text', ownerInfo.email, { readonly: true }));
                recordBody.appendChild(createBeneficialFormGroup('mobile', id, 'Mobile Number', 'text', beneficialInfo.mobile));
                recordBody.appendChild(createBeneficialFormGroup('taxNumber', id, 'Personal Income Tax Number', 'text', beneficialInfo.taxNumber));
                recordBody.appendChild(createBeneficialFormGroup('demographic', id, 'Demographic', 'select', beneficialInfo.demographic, { choices: [{ value: '', text: 'Select...' }, { value: 'Black', text: 'Black' }, { value: 'Coloured', text: 'Coloured' }, { value: 'Asian', text: 'Asian' }, { value: 'White', text: 'White' }] }));
                recordBody.appendChild(createBeneficialFormGroup('gender', id, 'Gender', 'select', beneficialInfo.gender, { choices: [{ value: '', text: 'Select...' }, { value: 'Male', text: 'Male' }, { value: 'Female', text: 'Female' }] }));
                recordBody.appendChild(createBeneficialFormGroup('disability', id, 'Disability', 'select', beneficialInfo.disability || 'Not Disabled', { choices: [{ value: 'Disabled', text: 'Disabled' }, { value: 'Not Disabled', text: 'Not Disabled' }] }));
                recordBody.appendChild(createBeneficialFormGroup('residenceCountry', id, 'Country of Residence', 'text', beneficialInfo.residenceCountry));
                recordBody.appendChild(createBeneficialFormGroup('originCountry', id, 'Country of Origin', 'text', beneficialInfo.originCountry));
                recordBody.appendChild(createBeneficialFormGroup('dateOfInterest', id, 'Date of Interest Type', 'date', ownerInfo.dateOfEntry, { readonly: true }));
                recordBody.appendChild(createBeneficialFormGroup('interestType', id, 'Interest Type', 'select', beneficialInfo.interestType, { choices: [{ value: '', text: 'Select...' }, { value: 'Voting Right', text: 'Voting Right' }, { value: 'Shareholding/Beneficial Ownership', text: 'Shareholding/Beneficial Ownership' }, { value: 'Appointment of Board', text: 'Appointment of Board' }, { value: 'Other influence or Control', text: 'Other influence or Control' }] }));
                recordBody.appendChild(createBeneficialFormGroup('ownershipPercentage', id, 'Shareholding/Beneficial Ownership (%)', 'text', percentage, { readonly: true }));
                recordBody.appendChild(createBeneficialFormGroup('address', id, 'Address', 'textarea', ownerInfo.address, { readonly: true }));

                container.appendChild(recordDiv);
            });

            document.getElementById('expandAllBeneficialBtn').addEventListener('click', () =>
            {
                document.querySelectorAll('#beneficialTab .info-record').forEach(rec => setBeneficialCollapseState(rec, true));
            });
            document.getElementById('collapseAllBeneficialBtn').addEventListener('click', () =>
            {
                document.querySelectorAll('#beneficialTab .info-record').forEach(rec => setBeneficialCollapseState(rec, false));
            });
        }

        // --- Config Save/Load and Data Management ---
        function showFilenameInput()
        {
            configFilenameInput.style.display = 'inline-block';
            saveConfigButton.style.display = 'inline-block';
            showSaveInputButton.style.display = 'none';
        }

        function getValueFromBeneficialTab(elementId)
        {
            const el = document.getElementById(elementId);
            if (!el) return '';
            if (el.classList.contains('visible-date-input')) return el.value;
            return el ? el.value : '';
        }

        function getCurrentStateData()
        {
            const data = { companyDetails: {}, shareholders: [] };
            data.companyDetails.name = document.getElementById('companyName').value;
            data.companyDetails.classOfShares = document.getElementById('companyClassOfShares').value;
            data.companyDetails.address = document.getElementById('companyAddressTextarea').value;
            data.companyDetails.authorizedShares = document.getElementById('authorizedShares').value;
            data.companyDetails.totalSharesIssued = document.getElementById('totalSharesIssued').value;
            data.companyDetails.companyRegNo = document.getElementById('companyRegNo').value;

            document.querySelectorAll('#shareholderRegister .shareholder-record').forEach(recordDiv =>
            {
                const recordType = recordDiv.dataset.recordType;
                const shareholder = {
                    id: recordDiv.dataset.id,
                    ownerDetails: { recordType: recordType },
                    acquiredTransactions: [],
                    transferredTransactions: [],
                    balance: {},
                    beneficialInfo: recordDiv.beneficialInfo || {}
                };

                shareholder.ownerDetails.address = recordDiv.querySelector('.ownerAddress')?.value || '';
                shareholder.ownerDetails.email = recordDiv.querySelector('.ownerEmail')?.value || '';
                shareholder.ownerDetails.dateOfEntry = getFormattedDate(recordDiv.querySelector('.dateOfEntry.visible-date-input'));
                shareholder.ownerDetails.dateOfCeasing = getFormattedDate(recordDiv.querySelector('.dateOfCeasing.visible-date-input'));
                shareholder.ownerDetails.classOfShares = recordDiv.querySelector('.classOfShares')?.value || '';

                if (recordType === 'natural')
                {
                    shareholder.ownerDetails.firstName = recordDiv.querySelector('.firstName')?.value || '';
                    shareholder.ownerDetails.surname = recordDiv.querySelector('.surname')?.value || '';
                    shareholder.ownerDetails.dateOfBirth = getFormattedDate(recordDiv.querySelector('.dateOfBirth.visible-date-input'));
                    shareholder.ownerDetails.idNumber = recordDiv.querySelector('.idNumber')?.value || '';
                    shareholder.ownerDetails.idCountry = recordDiv.querySelector('.idCountry')?.value || '';
                } else if (recordType === 'juristic')
                {
                    shareholder.ownerDetails.name = recordDiv.querySelector('.ownerName')?.value || '';
                    shareholder.ownerDetails.registrationNumber = recordDiv.querySelector('.registrationNumber')?.value || '';
                    shareholder.ownerDetails.registrationCountry = recordDiv.querySelector('.registrationCountryInput')?.value || '';
                }

                recordDiv.querySelectorAll('.acquired-transactions-container .transaction-row').forEach(row =>
                {
                    shareholder.acquiredTransactions.push({
                        date: getFormattedDate(row.querySelector('.transactionDate.visible-date-input')),
                        newCertNo: row.querySelector('.transactionNewCertNo').value,
                        shares: row.querySelector('.transactionShares').value,
                        nominalAmount: row.querySelector('.transactionNominalAmount')?.value || '',
                        details: row.querySelector('.transactionDetails').value
                    });
                });
                recordDiv.querySelectorAll('.transferred-transactions-container .transaction-row').forEach(row =>
                {
                    shareholder.transferredTransactions.push({
                        date: getFormattedDate(row.querySelector('.transactionDate.visible-date-input')),
                        newCertNo: row.querySelector('.transactionNewCertNo').value,
                        shares: row.querySelector('.transactionShares').value,
                        consideration: row.querySelector('.transactionConsideration')?.value || '',
                        details: row.querySelector('.transactionDetails').value
                    });
                });
                shareholder.balance.shares = recordDiv.querySelector('.balanceShares').value;
                shareholder.balance.certNos = recordDiv.querySelector('.balanceCertNos').value;

                const id = shareholder.id;
                if (document.getElementById(`ben_saCitizen_${id}`))
                {
                    shareholder.beneficialInfo = {
                        saCitizen: getValueFromBeneficialTab(`ben_saCitizen_${id}`),
                        issueDate: getValueFromBeneficialTab(`ben_issueDate_${id}`),
                        mobile: getValueFromBeneficialTab(`ben_mobile_${id}`),
                        taxNumber: getValueFromBeneficialTab(`ben_taxNumber_${id}`),
                        demographic: getValueFromBeneficialTab(`ben_demographic_${id}`),
                        gender: getValueFromBeneficialTab(`ben_gender_${id}`),
                        disability: getValueFromBeneficialTab(`ben_disability_${id}`),
                        residenceCountry: getValueFromBeneficialTab(`ben_residenceCountry_${id}`),
                        originCountry: getValueFromBeneficialTab(`ben_originCountry_${id}`),
                        interestType: getValueFromBeneficialTab(`ben_interestType_${id}`),
                    };
                }

                data.shareholders.push(shareholder);
            });
            return data;
        }

        function saveConfig()
        {
            const data = getCurrentStateData();
            const filename = configFilenameInput.value || 'share_register_config.json';
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(a.href);
            configFilenameInput.style.display = 'none'; configFilenameInput.value = '';
            saveConfigButton.style.display = 'none'; showSaveInputButton.style.display = 'inline-block';
        }

        function loadConfig(event)
        {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e)
            {
                try
                {
                    const data = JSON.parse(e.target.result);
                    shareholderRegisterDiv.innerHTML = '';
                    document.getElementById('beneficialTab').innerHTML = '';

                    const cd = data.companyDetails || {};
                    document.getElementById('companyName').value = cd.name || '';
                    document.getElementById('companyClassOfShares').value = cd.classOfShares || 'Ordinary';
                    document.getElementById('companyAddressTextarea').value = cd.address || '';
                    document.getElementById('authorizedShares').value = cd.authorizedShares || '';
                    document.getElementById('totalSharesIssued').value = cd.totalSharesIssued || '';
                    document.getElementById('companyRegNo').value = cd.companyRegNo || '';

                    if (data.shareholders && Array.isArray(data.shareholders))
                    {
                        data.shareholders.forEach(shareholderData =>
                        {
                            const recordType = shareholderData.ownerDetails.recordType || 'natural';
                            addShareholderRecord(recordType, shareholderData);
                        });
                    }
                    validateTotalIssuedShares();
                    updateShareholdingSummary();
                    alert('Configuration loaded successfully!');
                } catch (error)
                {
                    console.error("Error loading or parsing config file:", error);
                    alert('Error loading configuration file. Make sure it is a valid JSON file.');
                }
            };
            reader.readAsText(file);
            event.target.value = null; // Reset file input
        }

        // --- Summary and Validation ---
        function updateShareholdingSummary()
        {
            summaryTableBody.innerHTML = '';
            let grandTotalSharesHeld = 0;
            const companyTotalIssuedShares = parseInt(document.getElementById('totalSharesIssued').value) || 0;
            const defaultCompanyClassOfShares = document.getElementById('companyClassOfShares').value || 'N/A';

            document.querySelectorAll('#shareholderRegister .shareholder-record').forEach(recordDiv =>
            {
                let ownerName = (recordDiv.dataset.recordType === 'natural')
                    ? `${recordDiv.querySelector('.firstName')?.value || ''} ${recordDiv.querySelector('.surname')?.value || ''}`.trim()
                    : recordDiv.querySelector('.ownerName')?.value;
                ownerName = ownerName || 'N/A';

                const classOfShares = recordDiv.querySelector('.classOfShares')?.value || defaultCompanyClassOfShares;
                const balanceShares = parseInt(recordDiv.querySelector('.balanceShares')?.value) || 0;
                grandTotalSharesHeld += balanceShares;
                let percentage = (companyTotalIssuedShares > 0 && balanceShares > 0) ? (balanceShares / companyTotalIssuedShares) * 100 : 0;

                const row = summaryTableBody.insertRow();
                row.insertCell().textContent = ownerName;
                row.insertCell(1).textContent = classOfShares;
                row.insertCell(2).textContent = percentage.toFixed(2) + '%';
                row.insertCell(3).textContent = balanceShares;
                row.cells[1].className = 'class-of-shares-col';
                row.cells[2].className = 'percentage-col';
                row.cells[3].className = 'shares-col';
            });

            summaryTotalSharesHeldEl.textContent = grandTotalSharesHeld;
            const unaccountedShares = companyTotalIssuedShares - grandTotalSharesHeld;
            if (unaccountedShares !== 0)
            {
                summaryDiscrepancyMessageEl.textContent = unaccountedShares > 0
                    ? `${unaccountedShares} shares not accounted for in summary.`
                    : `${Math.abs(unaccountedShares)} shares over-allocated in summary.`;
                summaryDiscrepancyRowEl.style.display = 'table-row';
            } else
            {
                summaryDiscrepancyRowEl.style.display = 'none';
            }
        }

        function validateTotalIssuedShares()
        {
            const totalIssuedInput = document.getElementById('totalSharesIssued');
            const authorized = parseInt(document.getElementById('authorizedShares').value) || 0;
            const totalIssued = parseInt(totalIssuedInput.value) || 0;
            if (authorized > 0 && totalIssued > authorized)
            {
                totalIssuedInput.style.borderColor = 'red';
                totalIssuedInput.style.color = 'red';
            } else
            {
                totalIssuedInput.style.borderColor = '#ddd';
                totalIssuedInput.style.color = 'inherit';
            }
        }

        function prepareAndPrint(printClass)
        {
            document.body.className = printClass;
            const style = document.createElement('style');
            if (printClass === 'printing-cm42')
            {
                style.innerHTML = `@page { size: A4 portrait; margin: 1cm; }`;
            } else
            {
                style.innerHTML = `@page { size: A4 landscape; margin: 0.5cm; }`;
            }
            document.head.appendChild(style);

            window.print();

            setTimeout(() =>
            {
                document.body.className = '';
                document.head.removeChild(style);
            }, 500);
        }

        // --- START: Certificate Generation and Modal Logic ---
        function generateCertificate(buttonElement)
        {
            const transactionRow = buttonElement.closest('.transaction-row');
            const shareholderRecord = buttonElement.closest('.shareholder-record');
            if (!transactionRow || !shareholderRecord)
            {
                alert('Could not find required record data.');
                return;
            }

            const companyName = document.getElementById('companyName').value || '[COMPANY NAME]';
            const companyRegNo = document.getElementById('companyRegNo').value || '[Registration Number]';

            const recordType = shareholderRecord.dataset.recordType;
            let shareholderName;
            if (recordType === 'natural')
            {
                const firstName = shareholderRecord.querySelector('.firstName')?.value || '';
                const surname = shareholderRecord.querySelector('.surname')?.value || '';
                shareholderName = `${firstName} ${surname}`.trim();
            } else
            {
                shareholderName = shareholderRecord.querySelector('.ownerName')?.value || '';
            }
            const shareholderAddress = shareholderRecord.querySelector('.ownerAddress')?.value || '';
            const nameAndAddress = `${shareholderName}\n${shareholderAddress}`;

            const classOfShares = shareholderRecord.querySelector('.classOfShares')?.value || document.getElementById('companyClassOfShares').value || 'Ordinary - Par Value';

            const date = getFormattedDate(transactionRow.querySelector('.transactionDate.visible-date-input')) || '[DATE]';
            const certificateNumber = transactionRow.querySelector('.transactionNewCertNo').value || '[CERT#]';
            const numberOfShares = parseInt(transactionRow.querySelector('.transactionShares').value) || 0;
            const nominalAmount = transactionRow.querySelector('.transactionNominalAmount')?.value || '';

            const certificateHtml = `
                <div class="cert-header-1">SHARE CERTIFICATE</div>
                <div class="cert-header-2">${companyName}</div>
                <div class="cert-company-info">
                    (Incorporated in the Republic of South Africa)<br>
                    Registration number: ${companyRegNo}
                </div>
                <div class="cert-body-text">
                    This is to certify that the undermentioned is the registered proprietor of fully paid up shares as shown below
                    in the capital of the above company, subject to the Memorandum of Incorporation
                </div>
                <table class="cert-table">
                    <thead>
                        <tr>
                            <th>NAME AND ADDRESS</th>
                            <th>CLASS OF SHARES</th>
                            <th>NOMINAL AMOUNT</th>
                            <th>DATE</th>
                            <th>CERTIFICATE NUMBER</th>
                            <th>NUMBER OF SHARES</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="name-address-cell">${nameAndAddress}</td>
                            <td style="text-align: center;">${classOfShares}</td>
                            <td style="text-align: center;">${nominalAmount}</td>
                            <td style="text-align: center;">${date}</td>
                            <td style="text-align: center;">${certificateNumber}</td>
                            <td style="text-align: center;">${new Intl.NumberFormat().format(numberOfShares)}</td>
                        </tr>
                    </tbody>
                </table>
                <div class="cert-signature-section">
                    <div class="cert-signature-line"></div>
                    <div class="cert-director-label">DIRECTOR</div>
                </div>
            `;
            certificateContainer.innerHTML = certificateHtml;
            certificateModal.style.display = 'flex';
        }

        document.getElementById('closeCertificateBtn').addEventListener('click', () => { certificateModal.style.display = 'none'; });
        document.getElementById('printCertificateBtn').addEventListener('click', () => { prepareAndPrint('printing-certificate'); });

        // --- START: NEW CM42 Generation and Modal Logic ---
        function numberToWords(num)
        {
            const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
            const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
            if ((num = num.toString()).length > 9) return 'overflow';
            let n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
            if (!n) return; var str = '';
            str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'crore ' : '';
            str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'lakh ' : '';
            str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'thousand ' : '';
            str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'hundred ' : '';
            str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
            return str.trim().charAt(0).toUpperCase() + str.slice(1);
        }

        function populateTransfereeDetails(selectElement)
        {
            const selectedId = selectElement.value;
            const transfereeData = cm42DataStore.find(item => item.id === selectedId);
            const idInput = document.getElementById('cm42-transferee-id');
            const addressInput = document.getElementById('cm42-transferee-address');
            const emailInput = document.getElementById('cm42-transferee-email');

            if (transfereeData)
            {
                idInput.value = transfereeData.idNumber || '';
                addressInput.value = transfereeData.address || '';
                emailInput.value = transfereeData.email || '';
            } else
            {
                idInput.value = '';
                addressInput.value = '';
                emailInput.value = '';
            }
        }

        function generateCM42(buttonElement)
        {
            const transactionRow = buttonElement.closest('.transaction-row');
            const shareholderRecord = buttonElement.closest('.shareholder-record');
            if (!transactionRow || !shareholderRecord)
            {
                alert('Could not find required record data.');
                return;
            }

            cm42DataStore = [];
            cm42DataStore.push({
                id: 'company',
                name: document.getElementById('companyName').value || '[Company Name]',
                idNumber: document.getElementById('companyRegNo').value || '',
                address: document.getElementById('companyAddressTextarea').value || '',
                email: ''
            });
            document.querySelectorAll('#shareholderRegister .shareholder-record').forEach(recordDiv =>
            {
                const recordType = recordDiv.dataset.recordType;
                let name, idNumber;
                if (recordType === 'natural')
                {
                    name = `${recordDiv.querySelector('.firstName')?.value || ''} ${recordDiv.querySelector('.surname')?.value || ''}`.trim();
                    idNumber = recordDiv.querySelector('.idNumber')?.value || '';
                } else
                {
                    name = recordDiv.querySelector('.ownerName')?.value || '';
                    idNumber = recordDiv.querySelector('.registrationNumber')?.value || '';
                }
                cm42DataStore.push({
                    id: recordDiv.dataset.id,
                    name: name || 'Unnamed Record',
                    idNumber: idNumber,
                    address: recordDiv.querySelector('.ownerAddress')?.value || '',
                    email: recordDiv.querySelector('.ownerEmail')?.value || ''
                });
            });

            const transferorSelect = document.getElementById('cm42-transferor-name');
            const transfereeSelect = document.getElementById('cm42-transferee-name');
            transferorSelect.innerHTML = '';
            transfereeSelect.innerHTML = '<option value="">-- Select Transferee --</option>';

            cm42DataStore.forEach(item =>
            {
                const option = `<option value="${item.id}">${item.name}</option>`;
                transferorSelect.insertAdjacentHTML('beforeend', option);
                transfereeSelect.insertAdjacentHTML('beforeend', option);
            });

            const transferorId = shareholderRecord.dataset.id;
            const transferorData = cm42DataStore.find(item => item.id === transferorId);

            document.getElementById('cm42-issuer-name').value = document.getElementById('companyName').value;
            document.getElementById('cm42-security-description').value = shareholderRecord.querySelector('.classOfShares')?.value || document.getElementById('companyClassOfShares').value;
            document.getElementById('cm42-certificate-numbers').value = shareholderRecord.querySelector('.balanceCertNos').value;
            const quantity = transactionRow.querySelector('.transactionShares').value || 0;
            document.getElementById('cm42-quantity-figures').value = quantity;
            document.getElementById('cm42-quantity-words').value = numberToWords(quantity);

            transferorSelect.value = transferorId;
            transferorSelect.disabled = true;
            document.getElementById('cm42-transferor-id').value = transferorData ? transferorData.idNumber : '';

            transfereeSelect.value = "";
            populateTransfereeDetails(transfereeSelect);

            document.getElementById('cm42-consideration-amount').value = transactionRow.querySelector('.transactionConsideration').value || '';
            document.getElementById('cm42-transaction-date').value = getFormattedDate(transactionRow.querySelector('.transactionDate.visible-date-input'));

            cm42Modal.style.display = 'flex';
        }

        document.getElementById('cm42-transferee-name').addEventListener('change', (e) => populateTransfereeDetails(e.target));

        document.getElementById('closeCm42Btn').addEventListener('click', () =>
        {
            cm42Modal.style.display = 'none';
            document.getElementById('cm42-transferor-name').disabled = false;
        });
        document.getElementById('printCm42Btn').addEventListener('click', () => { prepareAndPrint('printing-cm42'); });

        document.getElementById('cm42-consideration-amount').addEventListener('blur', formatCm42Currency);

        // --- Initial calls on page load ---
        document.addEventListener('DOMContentLoaded', function ()
        {
            flatpickr("#cm42Container .date-input", {
                dateFormat: "d/m/Y",
            });

            validateTotalIssuedShares();
            updateShareholdingSummary();
        });
    </script>
</body>

</html>